{% extends 'base.html' %}

{% block title %}{{ room.name }} | {% endblock %}

{% block content %}
<div class="hero">
    <div class="hero-body">
        <h1 class="title has-text-centered has-text-white">{{ room.title }}</h1>
    </div>
</div>

<section class="section has-text-white">
    <div class="columns is-multiline">
        <div class="column is-8 is-offset-2">
            <div class="box messages" id="chat-messages">
                {% for m in messages %}<b>{{ m.user.username }}</b>: {{ m.content }}<br>{% endfor %}
            </div>
        </div>

        <div class="column is-8 is-offset-2">
            <div class="box">
                <div class="media">
                    <div class="media-content">
                        <form method="post" action=".">{% csrf_token %}
                            <div class="field">
                                <div class="control">
                                    <input type="text" name="content" id="chat-message-input" class="input" placeholder="Your message...">
                                </div>
                            </div>

                            <div class="field">
                                <div class="control">
                                    <button class="button" id="chat-message-submit">Submit</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block scripts %}
{{ room.slug|json_script:"json-roomname" }}
{{ request.user.username|json_script:"json-username" }}

<script>
    const roomName = JSON.parse(document.getElementById('json-roomname').textContent);
    const userName = JSON.parse(document.getElementById('json-username').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + roomName
        + '/'
    );

    chatSocket.onmessage = function(e) {
        console.log('onMessage');
    };

    chatSocket.onclose = function(e) {
        console.error('The socket closed unexpectedly');
    };
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.message) {
            document.querySelector('#chat-messages').innerHTML += ('<b>' + data.username + '</b>: ' + data.message + '<br>');
        } else {
            alert('The message was empty!')
        }
        scrollToBottom();
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;

        chatSocket.send(JSON.stringify({
            'message': message,
            'username': userName,
            'room': roomName
        }));

        messageInputDom.value = '';
    };
    function scrollToBottom() {
        let objDiv = document.getElementById("chat-messages");
        objDiv.scrollTop = objDiv.scrollHeight;
    }

    // Add this below the function to trigger the scroll on load.
    scrollToBottom();
</script>
{% endblock %}





{#<!DOCTYPE html>#}
{##}
{#<html>#}
{#    <head>#}
{#        <meta charset="utf-8"/>#}
{#        <title>Chatty</title>#}
{#        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">#}
{#    </head>#}
{##}
{#    <body>#}
{#        <section class="section">#}
{#            <div class="container">#}
{#                <div class="columns is-multiline">#}
{#                    <div class="column is-6 is-offset-3 mb-6">#}
{#                        <section class="hero is-link">#}
{#                            <div class="hero-body">#}
{#                                <p class="title is-1">#}
{#                                    Chat: {{ room.name }}#}
{#                                </p>#}
{#                            </div>#}
{#                        </section>#}
{#                    </div>#}
{##}
{#                    <div class="column is-6 is-offset-3">#}
{#                        <div class="box">#}
{#                            <div id="chat-messages" style="max-height: 300px; overflow-y: scroll;">{% for m in messages %}<b>{{ m.username }}</b>: {{ m.content }}<br>{% endfor %}</div>#}
{#                        </div>#}
{##}
{#                        <div class="field">#}
{#                            <div class="control">#}
{#                                <input class="input" type="text" placeholder="Message" id="chat-message-input">#}
{#                            </div>#}
{#                        </div>#}
{##}
{#                        <div class="field">#}
{#                            <div class="control">#}
{#                                <a class="button is-dark" id="chat-message-submit">Send</a>#}
{#                            </div>#}
{#                        </div>#}
{##}
{#                        <small class="has-text-grey-light">Your username: {{ username }}</small>#}
{#                        <div class="col-12 col-md-4">#}
{#                            <div class="select is-multiple">#}
{#                                <label for="onlineUsers">Online users</label>#}
{#                                <select multiple size="8" id="onlineUsersSelector">#}
{#                                </select>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </section>#}
{##}
{#       {{ room.name|json_script:"json-roomname" }}#}
{#       {{ username|json_script:"json-username" }}#}
{##}
{#        <script>#}
{#            function scrollToBottom() {#}
{#                let objDiv = document.getElementById("chat-messages");#}
{#                objDiv.scrollTop = objDiv.scrollHeight;#}
{#            }#}
{##}
{#            scrollToBottom();#}
{##}
{#            const roomName = JSON.parse(document.getElementById('json-roomname').textContent);#}
{#            const userName = JSON.parse(document.getElementById('json-username').textContent);#}
{##}
{#            const chatSocket = new WebSocket(#}
{#                'ws://'#}
{#                + window.location.host#}
{#                + '/ws/'#}
{#                + roomName#}
{#                + '/'#}
{#            );#}
{##}
{#            chatSocket.onmessage = function(e) {#}
{#                console.log('onmessage');#}
{##}
{#                const data = JSON.parse(e.data);#}
{##}
{#                if (data.message) {#}
{#                    document.querySelector('#chat-messages').innerHTML += ('<b>' + data.username + '</b>: ' + data.message + '<br>');#}
{#                } else {#}
{#                    alert('The message is empty!');#}
{#                }#}
{##}
{#                scrollToBottom();#}
{#            };#}
{##}
{#            chatSocket.onclose = function(e) {#}
{#                console.log('The socket close unexpectadly');#}
{#            };#}
{##}
{#            document.querySelector('#chat-message-submit').onclick = function(e) {#}
{#                const messageInputDom = document.querySelector('#chat-message-input');#}
{#                const message = messageInputDom.value;#}
{##}
{#                chatSocket.send(JSON.stringify({#}
{#                    'message': message,#}
{#                    'username': userName,#}
{#                    'room': roomName#}
{#                }));#}
{##}
{#                messageInputDom.value = '';#}
{#            };#}
{#        </script>#}
{#    </body>#}
{#</html>#}